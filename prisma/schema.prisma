// AI Creator Studio Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                String   @id @default(cuid())
  email             String   @unique
  name              String?
  passwordHash      String?
  role              String   @default("user") // user | admin | owner
  apiKeys           ApiKey[]
  // TikTok credentials
  tiktokClientId    String?
  tiktokClientSecret String?
  // Z.ai credentials
  zaiApiKey         String?
  // ElevenLabs credentials
  elevenLabsApiKey  String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("users")
}

// API Keys for authentication
model ApiKey {
  id          String   @id @default(cuid())
  key         String   @unique
  userId      String
  label       String?
  isActive    Boolean  @default(true)
  lastUsedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("api_keys")
}

// Character Model - 18 male characters
model Character {
  id            String   @id @default(cuid())
  code          String   @unique // ex: ID_01_A
  ethnicity     String   // korean, japanese, chinese, etc.
  baseAge       Int      // 18, 25, 35
  variant       String   // A, B, C
  aestheticType String   // cinematic or influencer
  embedding     Json?    // AI embedding data
  isActive      Boolean  @default(true)
  performanceScore Float @default(0.0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  contents      Content[]
  analytics     Analytics[]
  projects      Project[]
  
  @@map("characters")
}

// Content Model (Videos + Images)
model Content {
  id            String   @id @default(cuid())
  characterId   String
  productId     String?
  title         String
  description   String?
  promptCogView Json?    // CogView-4 prompts
  promptVidu    Json?    // Vidu-Q1 prompts
  status        String   @default("idea") // idea, generating, rendering, ready, posted, failed
  fileType      String   // image, video
  fileUrl       String?
  thumbnailUrl  String?
  duration      Int?     // seconds for video
  aesthetic     String   // cinematic, influencer
  tags          String?  // comma separated
  // TikTok integration
  tiktokPostId  String?
  tiktokPostUrl String?
  tiktokPostedAt DateTime?
scheduleId    String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  character     Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  analytics     Analytics[]
  schedule      Schedule? @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  
  @@map("contents")
}

// Analytics Model
model Analytics {
  id            String   @id @default(cuid())
  contentId     String   @unique
  characterId   String
  platform      String   @default("tiktok") // tiktok, instagram, etc.
  postId        String?  // platform-specific post ID
  views         Int      @default(0)
  likes         Int      @default(0)
  shares        Int      @default(0)
  saves         Int      @default(0)
  comments      Int      @default(0)
  sentiment     Float    @default(0.0)
  retentionData Json?    // retention curve data
  demographics  Json?    // demographic breakdown
  performanceScore Float @default(0.0)
  watchTimeRatio Float @default(0.0)
  rewatchRate   Float    @default(0.0)
  likeRate      Float    @default(0.0)
  shareRate     Float    @default(0.0)
  saveRate      Float    @default(0.0)
  engagementRate Float @default(0.0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  content       Content   @relation(fields: [contentId], references: [id], onDelete: Cascade)
  character     Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@map("analytics")
}

// Director Control Model (GLM-4.6 AI Director)
model DirectorControl {
  id            String   @id @default(cuid())
  characterRankings Json? // character performance rankings
  shotRankings     Json? // shot type rankings
  hookRankings     Json? // hook performance rankings
  aestheticRankings Json? // aesthetic performance rankings
  nextPlan          Json? // next generation plan
  lastAnalysis      DateTime @default(now())
  isActive          Boolean @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("director_controls")
}

// Scheduler Events

// Job Queue Model

// Job Queue Model
model JobQueue {
  id          String   @id @default(cuid())
  type        String   // image_generation, video_generation, director_plan, analytics_update
  status      String   @default("pending") // pending, processing, completed, failed
  priority    Int      @default(0)
  payload     Json     // job parameters
  result      Json?    // job result
  error       String?
  progress    Int      @default(0) // 0-100
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("job_queue")
}

// Trends Model
model Trend {
  id          String   @id @default(cuid())
  type        String   // sound, visual, pacing, hashtag
  title       String
  description String?
  source      String   // tiktok, instagram, etc.
  popularity  Float    @default(0.0)
  metadata    Json?    // additional trend data
  isActive    Boolean  @default(true)
  discoveredAt DateTime @default(now())
  expiresAt   DateTime?
  
  @@map("trends")
}

// Settings Model
model Setting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Json
  description String?
  updatedAt   DateTime @updatedAt
  
  @@map("settings")
}

// Schedule Model
model Schedule {
  id        String   @id @default(cuid())
  date      String
  title     String
  status    String   @default("scheduled")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  contents  Content[]

  @@map("schedules")
}

// Projects Model
model Project {
  id          String   @id @default(cuid())
  title       String
  description String?
  characterId String
  status      String   @default("draft") // draft, in_progress, completed
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  character   Character @relation(fields: [characterId], references: [id])

  @@map("projects")
}

// ============================================
// VIRAL ENGINE V3 MODELS
// ============================================

model ViralInsight {
  id          String   @id @default(cuid())
  script      String
  insights    Json
  createdAt   DateTime @default(now())
}

model VideoVariant {
  id          String   @id @default(cuid())
  baseScript  String
  variantType String
  output      Json
  createdAt   DateTime @default(now())
}

model HashtagGroup {
  id          String   @id @default(cuid())
  category    String
  tags        Json
  score       Int
  createdAt   DateTime @default(now())
}

model DescriptionGroup {
  id          String   @id @default(cuid())
  strength    String
  description String
  createdAt   DateTime @default(now())
}

model PerformanceSnapshot {
  id          String   @id @default(cuid())
  timestamp   DateTime @default(now())
  metrics     Json
}

model TikTokAccount {
  id            String   @id @default(cuid())
  username      String
  avatar        String?
  accessToken   String?
  refreshToken  String?
  createdAt     DateTime @default(now())
}

model SplitTest {
  id        String   @id @default(cuid())
  name      String
  variantA  Json
  variantB  Json
  winner    String?
  createdAt DateTime @default(now())
}

// ============================================
// TIKTOK HYBRID AUTO-POSTING MODELS
// ============================================

model TikTokAuth {
  id            String   @id @default(cuid())
  userId        String
  accountName   String
  accountType   String   // "business" | "creator"
  accessToken   String
  refreshToken  String?
  expiresAt     Int      // epoch timestamp
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model TikTokVideo {
  id            String   @id @default(cuid())
  userId        String
  authId        String
  fileUrl       String
  description   String
  hashtags      Json
  status        String   // "pending" | "uploaded" | "posted" | "failed"
  tiktokVideoId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model TikTokUploadQueue {
  id        String   @id @default(cuid())
  videoId   String
  authId    String
  mode      String   // "auto" | "draft"
  scheduleAt DateTime?
  attempts  Int      @default(0)
  status    String   // "queued" | "processing" | "done" | "failed"
  createdAt DateTime @default(now())
}

model TikTokPostLog {
  id        String   @id @default(cuid())
  videoId   String
  authId    String
  mode      String
  response  Json
  success   Boolean
  createdAt DateTime @default(now())
}